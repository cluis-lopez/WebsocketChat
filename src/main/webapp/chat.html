<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="author" content="Muhamad Nauval Azhar">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="description"
	content="This is a login page template based on Bootstrap 5">
<title>Tomcat WebSocket Chat</title>
<link
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/css/bootstrap.min.css"
	rel="stylesheet"
	integrity="sha384-BmbxuPwQa2lc/FVzBcNJ7UAyJxM6wuqIj61tLrc4wSX0szH/Ev+nYRRuWlolflfl"
	crossorigin="anonymous">
</head>

<body>
	<section class="h-100" id="selection">
		<div class="container h-100">
			<div class="row justify-content-sm-center h-100">
				<div class="col-xxl-4 col-xl-5 col-lg-5 col-md-7 col-sm-9">
					<div class="card shadow-lg">
						<div class="card-body p-3">
							<h1 class="fs-4 card-title fw-bold mb-4">Chats Recientes</h1>
						</div>
						<div class="mb-3">
							<div class="row height d-flex justify-content-center align-items-center">
								<div class="col-10">
									<div class="d-flex">
										<input type="text" class="form-control" placeholder="Busca usuarios o grupos" id="searchBox">
										<button class="btn btn-primary" id="searchButton">Search</button>
									</div>
								</div>
								<div class="col-10">
									<ul class="list-group" id="chatList">
									</ul>
								</div>
							</div>
						</div>
						<div class="card-footer py-3 border-0">
							<div class="text-center">
								<a href="#" class="text-dark" id="reload">Cargar &uacute;ltimos chats</a>
								
							</div>
						</div>
					</div>
					<div class="text-center mt-5 text-muted">Copyright &copy;
						2022 &mdash; Carlos L. Lopez</div>
				</div>
			</div>
		</div>
	</section>
	<section class="h-100" id="chatroom">
		<nav class="navbar fixed-top navbar-light bg-light">
  			<div class="container-fluid">
    			<a class="navbar-brand" href="#" id="chatWith">N.A.</a>
    			    <form class="d-flex">
      					<button class="btn btn-outline-success" type="submit" id="back">Back</button>
    				</form>
  			</div>
		</nav>
		<div class="container" id="mainchat">
			<div class="d-flex flex-row-reverse">
				<div class="card w-75">
  					<div class="card-body" style="background: Aquamarine;">
    					<h5 class="card-title">From Me</h5>
    					<p class="card-text">With supporting text below as a natural lead-in to additional content.</p>
    					<a href="#" class="btn btn-primary">Button</a>
  					</div>
				</div>
			</div>
			<div class="d-flex">
				<div class="card w-75">
  					<div class="card-body" style="background: LightSalmon;">
    					<h5 class="card-title">From Other</h5>
    					<p class="card-text">With supporting text below as a natural lead-in to additional content.</p>
    					<a href="#" class="btn btn-primary">Button</a>
  					</div>
				</div>
			</div>
		</div>
		<nav class="navbar fixed-bottom navbar-light bg-light">
  			<div class="container-fluid">
    			    <form class="d-flex justify-content-end">
      					<input class="form-control me-2 flex-grow-1" type="text" placeholder="Mensaje" aria-label="Mensaje">
      					<button class="btn btn-outline-success" type="submit" id="send">Enviar</button>
    				</form>
  			</div>
		</nav>
	</section>
	<script>
		'use strict';
		window.addEventListener(
						'load',
						function() {
							// Initialize app variables
							var payload = localStorage.getItem("payload");
        					if (payload == null)
            					location.href = "login.html";
        					var user = JSON.parse(payload);
        					document.getElementById("searchButton").addEventListener("click", searchChats);
        					document.getElementById("reload").addEventListener("click", reload);
        					document.getElementById("back").addEventListener("click", backToSelection);
        					var selection = document.getElementById("selection");
        					var chatroom = document.getElementById("chatroom");
        					chatroom.style.visibility="hidden";

							//Initialize the xhttp request
							var xhttp = new XMLHttpRequest();
							xhttp.open("GET", "/ChatServer/Userdata?id="+ user.id
									+ "&token=" + user.token + "&maxNumber=5&command=lastChats", true);
							xhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
							xhttp.setRequestHeader("Accept" , "application/json");
							xhttp.onload = function() {
								if (this.readyState == 4 && this.status == 200) {
									var resp = JSON.parse(this.responseText);
									if (resp.code == "OK") {
										var chats = resp.chatList;
										recreateList(chats);
									} else {
										console.log(resp.code);
										document.getElementById("warningtext").innerHTML = resp.code;
										myModal.show();
									}
								}
							};

							xhttp.onerror = function(e) {
								console.log("Error Unresponsive Domain ");
							};
							
							xhttp.send();
							
							function reload(){
								xhttp.open("GET", "/ChatServer/Userdata?id="+ user.id
										+ "&token=" + user.token + "&maxNumber=5&command=lastChats", true);
								xhttp.send();
							}
							
							function searchChats(){
								var searchText = document.getElementById("searchBox").value;
								if (searchText == "")
									return;
								xhttp.open("GET", "/ChatServer/Userdata?id="+ user.id
										+ "&token=" + user.token + "&maxNumber=5&command=search&searchChat=" + searchText, true);
								xhttp.send();
								
							};
							
							function recreateList(elements){
								var lista = document.getElementById("chatList");
								while (lista.firstChild){
									lista.removeChild(lista.firstChild );
								}
									
								for (var s in elements){
									if (elements[s] == "")
										continue;
									var l = document.createElement("li");
									l.setAttribute("id", "element_" + elements[s]);
									l.classList.add("list-group-item");
									l.appendChild(document.createTextNode(elements[s]));
									lista.appendChild(l);
									l.addEventListener("click", chatWith, false);
								}
							}
							
							function backToSelection() {
								chatroom.style.visibility="hidden";
								selection.style.visibility="visible";
							}
							
							function chatWith(evt){
								console.log("Chat with " + evt.currentTarget.id);
								selection.style.visibility="hidden";
								chatroom.style.visibility="visible";
								var chatWith = evt.currentTarget.id.slice(8);
								document.getElementById("chatWith").innerText = chatWith;
							};
					});
		</script>
</body>
</html>