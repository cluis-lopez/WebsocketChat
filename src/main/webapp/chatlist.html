<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="author" content="Muhamad Nauval Azhar">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="description"
	content="This is a login page template based on Bootstrap 5">
<title>Tomcat WebSocket Chat</title>
<link
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/css/bootstrap.min.css"
	rel="stylesheet"
	integrity="sha384-BmbxuPwQa2lc/FVzBcNJ7UAyJxM6wuqIj61tLrc4wSX0szH/Ev+nYRRuWlolflfl"
	crossorigin="anonymous">
</head>

<body>
	<section class="h-100" id="selection">
		<div class="container h-100">
			<div class="row justify-content-sm-center h-100">
				<div class="d-flex" style="height: 100px;">
  					<div class="vr"></div>
				</div>
				<div class="col-xxl-4 col-xl-5 col-lg-5 col-md-7 col-sm-9">
					<div class="card shadow-lg">
						<div class="card-body p-3">
							<h1 class="fs-4 card-title fw-bold mb-4">Chats Recientes</h1>
						</div>
						<div class="mb-3">
							<div class="row height d-flex justify-content-center align-items-center">
								<div class="col-10">
									<div class="d-flex">
										<input type="text" class="form-control" placeholder="Busca usuarios o grupos" id="searchBox">
										<button class="btn btn-primary" id="searchButton">Search</button>
									</div>
								</div>
								<div class="col-10">
									<ul class="list-group" id="chatList">
									</ul>
								</div>
							</div>
						</div>
						<div class="card-footer py-3 border-0">
							<div class="text-center">
								<a href="#" class="text-dark" id="reload">Cargar &uacute;ltimos chats</a>
								
							</div>
						</div>
					</div>
				</div>
				<div class="d-flex" style="height: 100px;">
  					<div class="vr"></div>
				</div>
				<div class="col-xxl-4 col-xl-5 col-lg-5 col-md-7 col-sm-9">
					<div class="card shadow-lg">
						<div class="card-footer py-3 border-0">
							<div class="text-center">
								<a href="#" class="text-dark" id="groups">Gestionar Grupos</a>
							</div>
						</div>
					</div>
					<div class="text-center mt-5 text-muted">Copyright &copy;
						2022 &mdash; Carlos L. Lopez</div>
				</div>
			</div>
		</div>
	</section>
	<script>
		'use strict';
		window.addEventListener(
						'load',
						function() {
							//Initialize app variables
							var credentials = localStorage.getItem("credentials");
        					if (credentials == null)
            					location.href = "login.html";
        					var user = JSON.parse(credentials);
        					var chatTo;
        					
        					// Initialize UI variables and components
        					document.getElementById("searchButton").addEventListener("click", searchChats);
        					document.getElementById("reload").addEventListener("click", reload);
        					var selection = document.getElementById("selection");

							//Initialize the unnatended xhttp request to get LastChats and search users/groups
							var xhttp = new XMLHttpRequest();
							xhttp.open("GET", "/ChatServer/Userdata?id="+ user.id
									+ "&token=" + user.token + "&maxNumber=5&command=lastChats", true);
							xhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
							xhttp.setRequestHeader("Accept" , "application/json");
							xhttp.onload = function() {
								if (this.readyState == 4 && this.status == 200) {
									var resp = JSON.parse(this.responseText);
									if (resp.code == "OK") {
										var chats = resp.chatList;
										recreateList(chats);
									} else {
										console.log(resp.code);
										location.href= "login.html";
									}
								}
							};

							xhttp.onerror = function(e) {
								console.log("Error Unresponsive Domain ");
							};
							
							xhttp.send();
							
							function reload(){
								xhttp.open("GET", "/ChatServer/Userdata?id="+ user.id
										+ "&token=" + user.token + "&maxNumber=5&command=lastChats", true);
								xhttp.send();
							}
							
							function searchChats(){
								var searchText = document.getElementById("searchBox").value;
								if (searchText == "")
									return;
								xhttp.open("GET", "/ChatServer/Userdata?id="+ user.id
										+ "&token=" + user.token + "&maxNumber=5&command=search&searchChat=" + searchText, true);
								xhttp.send();
								
							};
							
							function recreateList(elements){
								var lista = document.getElementById("chatList");
								while (lista.firstChild){
									lista.removeChild(lista.firstChild );
								}
									
								for (var s in elements){
									if (elements[s] == "")
										continue;
									var l = document.createElement("li");
									l.setAttribute("id", "element_" + elements[s]);
									l.classList.add("list-group-item");
									l.appendChild(document.createTextNode(elements[s]));
									lista.appendChild(l);
									l.addEventListener("click", chatWith, false);
								}
							}
												
							function chatWith(evt){
								console.log("Chat with " + evt.currentTarget.id);
								chatTo = evt.currentTarget.id.slice(8);
								console.log("chateando con: " + chatTo);
								location.href = "chatroom.html?chatTo=" + chatTo;
								//Load last messages from chat if any
							}							
			});
		</script>
</body>
</html>